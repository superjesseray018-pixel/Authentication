#!/bin/bash

# AI Protector Workshop - Kali Linux Penetration Testing Suite
# Week 5: Comprehensive security testing using Kali tools

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
MAGENTA='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Configuration
TARGET_URL="${1:-https://portfolio-app-with-authentication-owdjtrive.vercel.app}"
RESULTS_DIR="./pentest-results-$(date +%Y%m%d-%H%M%S)"

# Create results directory
mkdir -p "$RESULTS_DIR"

echo -e "${CYAN}"
echo "=========================================="
echo "  KALI LINUX PENETRATION TEST SUITE"
echo "=========================================="
echo -e "${NC}"
echo -e "${YELLOW}Target: $TARGET_URL${NC}"
echo -e "${YELLOW}Results: $RESULTS_DIR${NC}"
echo ""
echo -e "${RED}⚠️  WARNING: Only test applications you own or have permission to test!${NC}"
echo ""

# Function to check if tool is installed
check_tool() {
    if ! command -v $1 &> /dev/null; then
        echo -e "${RED}[!] $1 is not installed. Please install it first.${NC}"
        return 1
    fi
    echo -e "${GREEN}[✓] $1 is installed${NC}"
    return 0
}

# Check required tools
echo -e "${CYAN}[*] Checking required tools...${NC}"
check_tool "nmap"
check_tool "nikto"
check_tool "curl"
check_tool "whatweb"

echo ""
echo -e "${MAGENTA}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e "${MAGENTA}TEST 1: RECONNAISSANCE & INFORMATION GATHERING${NC}"
echo -e "${MAGENTA}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo ""

# Extract hostname from URL
HOSTNAME=$(echo "$TARGET_URL" | sed -e 's|^[^/]*//||' -e 's|/.*$||')

# DNS Enumeration
echo -e "${BLUE}[*] Running DNS enumeration...${NC}"
dig $HOSTNAME ANY +noall +answer > "$RESULTS_DIR/dns-records.txt" 2>&1
nslookup $HOSTNAME >> "$RESULTS_DIR/dns-records.txt" 2>&1
echo -e "${GREEN}[✓] DNS records saved to $RESULTS_DIR/dns-records.txt${NC}"

# Technology Detection
echo -e "${BLUE}[*] Detecting web technologies...${NC}"
whatweb -v "$TARGET_URL" > "$RESULTS_DIR/whatweb-scan.txt" 2>&1
echo -e "${GREEN}[✓] Technology scan saved to $RESULTS_DIR/whatweb-scan.txt${NC}"

# SSL/TLS Analysis
echo -e "${BLUE}[*] Analyzing SSL/TLS configuration...${NC}"
if command -v testssl.sh &> /dev/null; then
    testssl.sh --fast "$TARGET_URL" > "$RESULTS_DIR/ssl-scan.txt" 2>&1
    echo -e "${GREEN}[✓] SSL/TLS scan saved to $RESULTS_DIR/ssl-scan.txt${NC}"
else
    echo -e "${YELLOW}[!] testssl.sh not found, skipping SSL scan${NC}"
fi

echo ""
echo -e "${MAGENTA}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e "${MAGENTA}TEST 2: PORT SCANNING${NC}"
echo -e "${MAGENTA}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo ""

echo -e "${BLUE}[*] Running nmap port scan...${NC}"
nmap -sV -sC -p 80,443,8080,8443 $HOSTNAME -oN "$RESULTS_DIR/nmap-scan.txt" > /dev/null 2>&1
echo -e "${GREEN}[✓] Nmap scan saved to $RESULTS_DIR/nmap-scan.txt${NC}"

echo ""
echo -e "${MAGENTA}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e "${MAGENTA}TEST 3: WEB APPLICATION SCANNING${NC}"
echo -e "${MAGENTA}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo ""

echo -e "${BLUE}[*] Running Nikto web server scanner...${NC}"
nikto -h "$TARGET_URL" -output "$RESULTS_DIR/nikto-scan.txt" -Format txt > /dev/null 2>&1
echo -e "${GREEN}[✓] Nikto scan saved to $RESULTS_DIR/nikto-scan.txt${NC}"

echo ""
echo -e "${MAGENTA}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e "${MAGENTA}TEST 4: SECURITY HEADERS CHECK${NC}"
echo -e "${MAGENTA}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo ""

echo -e "${BLUE}[*] Checking security headers...${NC}"
{
    echo "Security Headers Analysis"
    echo "========================="
    echo ""
    curl -I "$TARGET_URL" 2>/dev/null | grep -i "strict-transport-security\|x-frame-options\|x-content-type-options\|x-xss-protection\|content-security-policy\|referrer-policy\|permissions-policy"
} > "$RESULTS_DIR/security-headers.txt"

# Parse headers
HEADERS_FOUND=0
HEADERS_MISSING=0

while IFS= read -r line; do
    if [[ $line =~ ^(Strict-Transport-Security|X-Frame-Options|X-Content-Type-Options|X-XSS-Protection|Content-Security-Policy|Referrer-Policy|Permissions-Policy) ]]; then
        HEADERS_FOUND=$((HEADERS_FOUND + 1))
        echo -e "${GREEN}[✓] Found: $line${NC}"
    fi
done < "$RESULTS_DIR/security-headers.txt"

echo ""
echo -e "${CYAN}Security Headers Score: $HEADERS_FOUND/7${NC}"
echo -e "${GREEN}[✓] Security headers analysis saved to $RESULTS_DIR/security-headers.txt${NC}"

echo ""
echo -e "${MAGENTA}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e "${MAGENTA}TEST 5: RATE LIMITING TEST${NC}"
echo -e "${MAGENTA}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo ""

echo -e "${BLUE}[*] Testing rate limiting (sending 150 requests)...${NC}"
{
    echo "Rate Limiting Test Results"
    echo "=========================="
    echo ""
    
    SUCCESS=0
    BLOCKED=0
    RATE_LIMITED=0
    
    for i in {1..150}; do
        RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" -X POST "$TARGET_URL/api/newsletter" \
            -H "Content-Type: application/json" \
            -d "{\"email\":\"test$i@example.com\"}" 2>/dev/null)
        
        case $RESPONSE in
            200|201)
                SUCCESS=$((SUCCESS + 1))
                ;;
            401|403)
                BLOCKED=$((BLOCKED + 1))
                ;;
            429)
                RATE_LIMITED=$((RATE_LIMITED + 1))
                ;;
        esac
        
        if [ $((i % 30)) -eq 0 ]; then
            echo -e "${YELLOW}  Sent $i requests...${NC}"
        fi
    done
    
    echo ""
    echo "Results:"
    echo "  Success (200/201): $SUCCESS"
    echo "  Blocked (401/403): $BLOCKED"
    echo "  Rate Limited (429): $RATE_LIMITED"
    echo ""
    
    if [ $RATE_LIMITED -gt 0 ]; then
        echo "✓ Rate limiting is ACTIVE"
    else
        echo "✗ Rate limiting may not be configured"
    fi
} | tee "$RESULTS_DIR/rate-limit-test.txt"

echo ""
echo -e "${MAGENTA}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e "${MAGENTA}TEST 6: SQL INJECTION TEST${NC}"
echo -e "${MAGENTA}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo ""

echo -e "${BLUE}[*] Testing SQL injection payloads...${NC}"
{
    echo "SQL Injection Test Results"
    echo "==========================="
    echo ""
    
    PAYLOADS=(
        "' OR '1'='1"
        "' OR '1'='1' --"
        "'; DROP TABLE users--"
        "' UNION SELECT NULL--"
        "admin'--"
        "' OR 1=1--"
        "1' AND '1'='1"
        "' UNION SELECT * FROM users--"
        "1' OR '1'='1' /*"
        "'; EXEC sp_MSForEachTable 'DROP TABLE ?'--"
    )
    
    VULNERABLE=0
    PROTECTED=0
    
    for payload in "${PAYLOADS[@]}"; do
        RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" -X POST "$TARGET_URL/api/newsletter" \
            -H "Content-Type: application/json" \
            -d "{\"email\":\"$payload\"}" 2>/dev/null)
        
        echo "Payload: $payload"
        echo "Response: $RESPONSE"
        
        if [ "$RESPONSE" = "200" ] || [ "$RESPONSE" = "201" ]; then
            VULNERABLE=$((VULNERABLE + 1))
            echo "Status: ⚠️  POTENTIAL VULNERABILITY"
        else
            PROTECTED=$((PROTECTED + 1))
            echo "Status: ✓ BLOCKED"
        fi
        echo ""
    done
    
    echo "Summary:"
    echo "  Protected: $PROTECTED/${#PAYLOADS[@]}"
    echo "  Vulnerable: $VULNERABLE/${#PAYLOADS[@]}"
    echo ""
    
    if [ $VULNERABLE -eq 0 ]; then
        echo "✓ SQL Injection protection is ACTIVE"
    else
        echo "✗ VULNERABILITY DETECTED: SQL injection may be possible"
    fi
} | tee "$RESULTS_DIR/sql-injection-test.txt"

echo ""
echo -e "${MAGENTA}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e "${MAGENTA}TEST 7: XSS (CROSS-SITE SCRIPTING) TEST${NC}"
echo -e "${MAGENTA}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo ""

echo -e "${BLUE}[*] Testing XSS payloads...${NC}"
{
    echo "XSS Test Results"
    echo "================"
    echo ""
    
    XSS_PAYLOADS=(
        "<script>alert('XSS')</script>"
        "<img src=x onerror=alert('XSS')>"
        "<svg/onload=alert('XSS')>"
        "javascript:alert('XSS')"
        "<iframe src=javascript:alert('XSS')>"
        "<body onload=alert('XSS')>"
        "<input onfocus=alert('XSS') autofocus>"
        "<marquee onstart=alert('XSS')>"
    )
    
    VULNERABLE=0
    PROTECTED=0
    
    for payload in "${XSS_PAYLOADS[@]}"; do
        RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" -X POST "$TARGET_URL/api/newsletter" \
            -H "Content-Type: application/json" \
            -d "{\"email\":\"$payload@test.com\"}" 2>/dev/null)
        
        echo "Payload: $payload"
        echo "Response: $RESPONSE"
        
        if [ "$RESPONSE" = "200" ] || [ "$RESPONSE" = "201" ]; then
            VULNERABLE=$((VULNERABLE + 1))
            echo "Status: ⚠️  NEEDS REVIEW"
        else
            PROTECTED=$((PROTECTED + 1))
            echo "Status: ✓ BLOCKED/SANITIZED"
        fi
        echo ""
    done
    
    echo "Summary:"
    echo "  Protected: $PROTECTED/${#XSS_PAYLOADS[@]}"
    echo "  Need Review: $VULNERABLE/${#XSS_PAYLOADS[@]}"
    echo ""
    
    if [ $VULNERABLE -eq 0 ]; then
        echo "✓ XSS protection appears ACTIVE"
    else
        echo "⚠️  Review: Some payloads were accepted (may be sanitized)"
    fi
} | tee "$RESULTS_DIR/xss-test.txt"

echo ""
echo -e "${CYAN}=========================================="
echo "  PENETRATION TEST SUITE COMPLETE"
echo "==========================================${NC}"
echo ""
echo -e "${GREEN}All tests completed successfully!${NC}"
echo ""
echo -e "${YELLOW}Results saved to: $RESULTS_DIR${NC}"
echo ""
echo "Report Files:"
ls -lh "$RESULTS_DIR"
echo ""
echo -e "${CYAN}Next Steps:${NC}"
echo "  1. Review all test results in $RESULTS_DIR"
echo "  2. Document any vulnerabilities found"
echo "  3. Implement remediations for high-risk issues"
echo "  4. Re-test after fixes are applied"
echo ""
