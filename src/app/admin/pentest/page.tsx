// Live Penetration Testing Dashboard Component
// Admin-only access to real-time security testing

'use client'

import { useState, useEffect, useRef } from 'react'
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
import { Button } from '@/components/ui/button'
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs'
import { Badge } from '@/components/ui/badge'
import { ScrollArea } from '@/components/ui/scroll-area'
import { Alert, AlertDescription } from '@/components/ui/alert'
import { 
  Terminal, 
  Play, 
  Square, 
  RefreshCw, 
  Shield, 
  AlertTriangle,
  CheckCircle,
  XCircle,
  Activity,
  Download,
  Settings
} from 'lucide-react'

interface TestResult {
  id: string
  test: string
  status: 'running' | 'pass' | 'fail' | 'warning'
  message: string
  timestamp: Date
  details?: string
}

export default function LivePentestDashboard() {
  const [isRunning, setIsRunning] = useState(false)
  const [testResults, setTestResults] = useState<TestResult[]>([])
  const [terminalOutput, setTerminalOutput] = useState<string[]>([])
  const [selectedTest, setSelectedTest] = useState<string>('all')
  const [autoScroll, setAutoScroll] = useState(true)
  const terminalRef = useRef<HTMLDivElement>(null)

  // Auto-scroll terminal
  useEffect(() => {
    if (autoScroll && terminalRef.current) {
      terminalRef.current.scrollTop = terminalRef.current.scrollHeight
    }
  }, [terminalOutput, autoScroll])

  // Simulate terminal output (replace with actual WebSocket connection)
  const addTerminalLine = (line: string) => {
    setTerminalOutput(prev => [...prev, `[${new Date().toLocaleTimeString()}] ${line}`])
  }

  // Run security tests
  const runSecurityTest = async (testType: string) => {
    setIsRunning(true)
    addTerminalLine(`Starting ${testType} test...`)

    try {
      const response = await fetch('/api/pentest/run', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ testType })
      })

      if (!response.ok) throw new Error('Test failed to start')

      // Stream results (if using Server-Sent Events or WebSocket)
      const reader = response.body?.getReader()
      const decoder = new TextDecoder()

      if (reader) {
        while (true) {
          const { done, value } = await reader.read()
          if (done) break

          const text = decoder.decode(value)
          const lines = text.split('\n').filter(l => l.trim())

          lines.forEach(line => {
            addTerminalLine(line)
            
            // Parse test results
            try {
              const result = JSON.parse(line)
              if (result.test) {
                setTestResults(prev => [...prev, {
                  ...result,
                  id: Date.now().toString(),
                  timestamp: new Date()
                }])
              }
            } catch {
              // Not JSON, just terminal output
            }
          })
        }
      }

      addTerminalLine(`${testType} test completed.`)
    } catch (error) {
      addTerminalLine(`Error: ${error}`)
    } finally {
      setIsRunning(false)
    }
  }

  // Quick test function (demo - replace with actual API)
  const runQuickTest = async () => {
    setIsRunning(true)
    setTerminalOutput([])
    setTestResults([])

    const tests = [
      { name: 'Security Headers', endpoint: '/api/pentest/headers' },
      { name: 'Rate Limiting', endpoint: '/api/pentest/rate-limit' },
      { name: 'SQL Injection', endpoint: '/api/pentest/sql-injection' },
      { name: 'XSS Protection', endpoint: '/api/pentest/xss' },
      { name: 'Auth Bypass', endpoint: '/api/pentest/auth' },
    ]

    for (const test of tests) {
      addTerminalLine(`Running ${test.name}...`)
      
      try {
        const response = await fetch(test.endpoint, { method: 'POST' })
        const result = await response.json()
        
        setTestResults(prev => [...prev, {
          id: Date.now().toString() + Math.random(),
          test: test.name,
          status: result.passed ? 'pass' : 'fail',
          message: result.message,
          timestamp: new Date(),
          details: result.details
        }])

        addTerminalLine(`✓ ${test.name}: ${result.message}`)
      } catch (error) {
        addTerminalLine(`✗ ${test.name}: Failed`)
      }

      await new Promise(resolve => setTimeout(resolve, 500))
    }

    addTerminalLine('All tests completed.')
    setIsRunning(false)
  }

  const stopTests = () => {
    setIsRunning(false)
    addTerminalLine('Tests stopped by user.')
  }

  const clearTerminal = () => {
    setTerminalOutput([])
    setTestResults([])
  }

  const exportResults = () => {
    const data = {
      timestamp: new Date().toISOString(),
      results: testResults,
      terminalLog: terminalOutput
    }
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' })
    const url = URL.createObjectURL(blob)
    const a = document.createElement('a')
    a.href = url
    a.download = `pentest-results-${Date.now()}.json`
    a.click()
  }

  const getStatusIcon = (status: string) => {
    switch (status) {
      case 'pass': return <CheckCircle className="h-4 w-4 text-green-500" />
      case 'fail': return <XCircle className="h-4 w-4 text-red-500" />
      case 'warning': return <AlertTriangle className="h-4 w-4 text-yellow-500" />
      case 'running': return <Activity className="h-4 w-4 text-blue-500 animate-pulse" />
      default: return null
    }
  }

  const getStatusBadge = (status: string) => {
    const variants: Record<string, any> = {
      pass: 'default',
      fail: 'destructive',
      warning: 'secondary',
      running: 'outline'
    }
    return (
      <Badge variant={variants[status] || 'outline'}>
        {status.toUpperCase()}
      </Badge>
    )
  }

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div>
          <h2 className="text-3xl font-bold tracking-tight">Live Penetration Testing</h2>
          <p className="text-muted-foreground">
            Real-time security testing and vulnerability scanning
          </p>
        </div>
        <div className="flex gap-2">
          <Button
            onClick={runQuickTest}
            disabled={isRunning}
            className="gap-2"
          >
            {isRunning ? (
              <>
                <RefreshCw className="h-4 w-4 animate-spin" />
                Running...
              </>
            ) : (
              <>
                <Play className="h-4 w-4" />
                Run Quick Test
              </>
            )}
          </Button>
          {isRunning && (
            <Button
              onClick={stopTests}
              variant="destructive"
              className="gap-2"
            >
              <Square className="h-4 w-4" />
              Stop
            </Button>
          )}
          <Button
            onClick={exportResults}
            variant="outline"
            disabled={testResults.length === 0}
            className="gap-2"
          >
            <Download className="h-4 w-4" />
            Export
          </Button>
        </div>
      </div>

      {/* Alert */}
      <Alert>
        <Shield className="h-4 w-4" />
        <AlertDescription>
          <strong>Authorization Notice:</strong> These tests are performed on your own application. 
          Never run penetration tests on systems you don't own or have explicit permission to test.
        </AlertDescription>
      </Alert>

      {/* Main Content */}
      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
        {/* Terminal Output */}
        <Card className="lg:col-span-2">
          <CardHeader>
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-2">
                <Terminal className="h-5 w-5" />
                <CardTitle>Terminal Output</CardTitle>
              </div>
              <div className="flex items-center gap-2">
                <Button
                  size="sm"
                  variant="ghost"
                  onClick={() => setAutoScroll(!autoScroll)}
                >
                  Auto-scroll: {autoScroll ? 'ON' : 'OFF'}
                </Button>
                <Button
                  size="sm"
                  variant="ghost"
                  onClick={clearTerminal}
                >
                  Clear
                </Button>
              </div>
            </div>
          </CardHeader>
          <CardContent>
            <ScrollArea
              ref={terminalRef}
              className="h-[500px] w-full rounded-md border bg-black p-4 font-mono text-sm"
            >
              {terminalOutput.length === 0 ? (
                <div className="text-green-400">
                  <p>$ Ready to run security tests...</p>
                  <p className="text-gray-500 mt-2">Click "Run Quick Test" to start</p>
                </div>
              ) : (
                terminalOutput.map((line, i) => (
                  <div key={i} className="text-green-400 mb-1">
                    {line}
                  </div>
                ))
              )}
            </ScrollArea>
          </CardContent>
        </Card>

        {/* Test Results Summary */}
        <Card>
          <CardHeader>
            <CardTitle>Test Results</CardTitle>
            <CardDescription>
              {testResults.length} tests completed
            </CardDescription>
          </CardHeader>
          <CardContent>
            <ScrollArea className="h-[500px]">
              <div className="space-y-3">
                {testResults.length === 0 ? (
                  <p className="text-sm text-muted-foreground text-center py-8">
                    No test results yet
                  </p>
                ) : (
                  testResults.map(result => (
                    <div
                      key={result.id}
                      className="flex items-start gap-3 p-3 rounded-lg border bg-card hover:bg-accent/50 transition-colors"
                    >
                      <div className="mt-1">
                        {getStatusIcon(result.status)}
                      </div>
                      <div className="flex-1 space-y-1">
                        <div className="flex items-center justify-between">
                          <p className="text-sm font-medium">{result.test}</p>
                          {getStatusBadge(result.status)}
                        </div>
                        <p className="text-xs text-muted-foreground">
                          {result.message}
                        </p>
                        <p className="text-xs text-muted-foreground">
                          {result.timestamp.toLocaleTimeString()}
                        </p>
                      </div>
                    </div>
                  ))
                )}
              </div>
            </ScrollArea>
          </CardContent>
        </Card>
      </div>

      {/* Test Categories */}
      <Card>
        <CardHeader>
          <CardTitle>Test Categories</CardTitle>
          <CardDescription>Select specific security tests to run</CardDescription>
        </CardHeader>
        <CardContent>
          <Tabs defaultValue="all" className="w-full">
            <TabsList className="grid w-full grid-cols-6">
              <TabsTrigger value="all">All Tests</TabsTrigger>
              <TabsTrigger value="headers">Headers</TabsTrigger>
              <TabsTrigger value="injection">Injection</TabsTrigger>
              <TabsTrigger value="auth">Auth</TabsTrigger>
              <TabsTrigger value="rate">Rate Limit</TabsTrigger>
              <TabsTrigger value="custom">Custom</TabsTrigger>
            </TabsList>

            <TabsContent value="all" className="space-y-4">
              <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
                {[
                  'Security Headers',
                  'Rate Limiting',
                  'SQL Injection',
                  'XSS Protection',
                  'CSRF Protection',
                  'Auth Bypass',
                  'Bot Detection',
                  'API Security',
                  'Session Management'
                ].map(test => (
                  <Button
                    key={test}
                    variant="outline"
                    className="justify-start"
                    onClick={() => runSecurityTest(test)}
                    disabled={isRunning}
                  >
                    <Shield className="h-4 w-4 mr-2" />
                    {test}
                  </Button>
                ))}
              </div>
            </TabsContent>

            <TabsContent value="headers">
              <div className="space-y-2">
                <p className="text-sm text-muted-foreground">
                  Test security headers: HSTS, CSP, X-Frame-Options, etc.
                </p>
                <Button onClick={() => runSecurityTest('Security Headers')}>
                  Run Headers Test
                </Button>
              </div>
            </TabsContent>

            <TabsContent value="injection">
              <div className="space-y-2">
                <p className="text-sm text-muted-foreground">
                  Test for SQL injection, XSS, and other injection attacks
                </p>
                <div className="flex gap-2">
                  <Button onClick={() => runSecurityTest('SQL Injection')}>
                    SQL Injection
                  </Button>
                  <Button onClick={() => runSecurityTest('XSS Protection')}>
                    XSS Test
                  </Button>
                </div>
              </div>
            </TabsContent>

            <TabsContent value="auth">
              <div className="space-y-2">
                <p className="text-sm text-muted-foreground">
                  Test authentication and authorization controls
                </p>
                <Button onClick={() => runSecurityTest('Auth Bypass')}>
                  Run Auth Tests
                </Button>
              </div>
            </TabsContent>

            <TabsContent value="rate">
              <div className="space-y-2">
                <p className="text-sm text-muted-foreground">
                  Test rate limiting and DDoS protection
                </p>
                <Button onClick={() => runSecurityTest('Rate Limiting')}>
                  Run Rate Limit Test
                </Button>
              </div>
            </TabsContent>

            <TabsContent value="custom">
              <div className="space-y-2">
                <p className="text-sm text-muted-foreground">
                  Configure and run custom security tests
                </p>
                <Button variant="outline" disabled>
                  <Settings className="h-4 w-4 mr-2" />
                  Configure Custom Tests (Coming Soon)
                </Button>
              </div>
            </TabsContent>
          </Tabs>
        </CardContent>
      </Card>

      {/* Statistics */}
      <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
        <Card>
          <CardHeader className="pb-2">
            <CardTitle className="text-sm font-medium">Total Tests</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">{testResults.length}</div>
          </CardContent>
        </Card>
        <Card>
          <CardHeader className="pb-2">
            <CardTitle className="text-sm font-medium">Passed</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold text-green-500">
              {testResults.filter(r => r.status === 'pass').length}
            </div>
          </CardContent>
        </Card>
        <Card>
          <CardHeader className="pb-2">
            <CardTitle className="text-sm font-medium">Failed</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold text-red-500">
              {testResults.filter(r => r.status === 'fail').length}
            </div>
          </CardContent>
        </Card>
        <Card>
          <CardHeader className="pb-2">
            <CardTitle className="text-sm font-medium">Warnings</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold text-yellow-500">
              {testResults.filter(r => r.status === 'warning').length}
            </div>
          </CardContent>
        </Card>
      </div>
    </div>
  )
}