import { NextResponse } from 'next/server'
import { auth } from '@clerk/nextjs/server'

export async function POST() {
  const authResult = await auth()
  if (!authResult.userId) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
  }

  try {
    const targetUrl = process.env.NEXT_PUBLIC_APP_URL || 'https://portfolio-app-with-authentication-owdjtrive.vercel.app'
    const response = await fetch(targetUrl, { method: 'HEAD' })
    
    const requiredHeaders = [
      'strict-transport-security',
      'x-frame-options',
      'x-content-type-options',
      'content-security-policy',
      'referrer-policy',
      'permissions-policy'
    ]
    
    const found = requiredHeaders.filter(h => response.headers.get(h))
    const passed = found.length === requiredHeaders.length
    
    return NextResponse.json({
      passed,
      message: `${found.length}/${requiredHeaders.length} security headers present`,
      details: `Found: ${found.join(', ')}`,
      score: Math.round((found.length / requiredHeaders.length) * 100)
    })
  } catch (error) {
    return NextResponse.json({
      passed: false,
      message: `Test failed: ${error}`,
      details: null
    })
  }
}