import { NextResponse } from 'next/server'
import { auth } from '@clerk/nextjs/server'

export async function POST() {
  const authResult = await auth()
  if (!authResult.userId) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
  }

  try {
    const targetUrl = process.env.NEXT_PUBLIC_APP_URL || 'https://portfolio-app-with-authentication-owdjtrive.vercel.app'
    
    const protectedRoutes = [
      '/dashboard',
      '/admin',
      '/api/monitoring'
    ]
    
    let protectedCount = 0
    let accessibleCount = 0
    
    for (const route of protectedRoutes) {
      try {
        const response = await fetch(`${targetUrl}${route}`, {
          redirect: 'manual'
        })
        
        // 401, 403, or 307 redirect means protected
        if (response.status === 401 || response.status === 403 || response.status === 307) {
          protectedCount++
        } else if (response.ok) {
          accessibleCount++
        }
      } catch {
        protectedCount++
      }
    }
    
    const passed = accessibleCount === 0
    
    return NextResponse.json({
      passed,
      message: passed 
        ? `All protected routes secured (${protectedCount}/${protectedRoutes.length})` 
        : `VULNERABLE: ${accessibleCount} routes accessible without auth`,
      details: `Tested: ${protectedRoutes.length}, Protected: ${protectedCount}, Accessible: ${accessibleCount}`,
      protectedCount,
      accessibleCount
    })
  } catch (error) {
    return NextResponse.json({
      passed: false,
      message: `Test failed: ${error}`,
      details: null
    })
  }
}